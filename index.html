<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å½±è§£æPWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f0f5;
      padding: 20px;
      color: #333;
    }
    h2, h3 { color: #2c3e50; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, button {
      margin: 8px 0;
      padding: 8px;
      width: 100%;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background-color: #3498db;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #2980b9; }
    #resetShadowBtn { background-color: #e74c3c; }
    #resetShadowBtn:hover { background-color: #c0392b; }
    #forceEstimateBtn { background-color: #16a085; }
    #forceEstimateBtn:hover { background-color: #138d75; }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
      max-width: 100%;
      touch-action: none;
    }
    pre {
      background: #fff;
      padding: 12px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
      font-size: 0.95em;
    }
    .note {
      font-size: 0.9em;
      color: #555;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“¸ å½±è§£æPWA</h2>
  <input type="file" id="imageInput" accept="image/*">

  <h3>ğŸŒ æ‰‹å‹•å…¥åŠ›</h3>
  <label for="latitude">ç·¯åº¦ï¼ˆä¾‹: 35.6895ï¼‰</label>
  <input type="text" id="latitude" placeholder="ç·¯åº¦ã‚’å…¥åŠ›">
  <label for="longitude">çµŒåº¦ï¼ˆä¾‹: 139.6917ï¼‰</label>
  <input type="text" id="longitude" placeholder="çµŒåº¦ã‚’å…¥åŠ›">
  <label for="dateInput">ğŸ“… æ’®å½±æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
  <input type="date" id="dateInput">

  <button id="markShadowBtn">âœï¸ å½±ã‚’ãƒãƒ¼ã‚¯</button>
  <button id="resetShadowBtn">ğŸ”„ å½±ãƒãƒ¼ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ</button>

  <canvas id="canvas" width="600" height="400"></canvas>

  <button id="estimateTimeBtn">ğŸ” æ™‚åˆ»æ¨å®šã‚’å®Ÿè¡Œ</button>

  <p class="note">
    â€»å½±ãŒãªã„ãƒ»ãƒãƒ¼ã‚¯ã§ããªã„å ´åˆã¯ã€Œå½±ãªã—å¼·åˆ¶æ™‚åˆ»æ¤œå‡ºã€ã§  
    å¤ªé™½ã®å—ä¸­ï¼ˆsolarNoonï¼æœ€ã‚‚çœŸå—ã«æ¥ã‚‹æ™‚åˆ»ï¼‰ã‚’æ’®å½±æ™‚åˆ»ã®æ¨å®šå€¤ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚
  </p>
  <button id="forceEstimateBtn">â˜€ï¸ å½±ãªã—å¼·åˆ¶æ™‚åˆ»æ¤œå‡º</button>

  <h3>ğŸ“¦ çµæœ</h3>
  <pre id="output">è§£æçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</pre>

  <!-- Exif.js -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <!-- SunCalc.js -->
  <script src="https://cdn.jsdelivr.net/npm/suncalc/suncalc.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const canvas = document.getElementById('canvas');
    const ctx    = canvas.getContext('2d');
    let img, shadowPoints = [], marking = false, measuredAz = null;

    function normalizeAngle(a) {
      return ((a + Math.PI) % (2 * Math.PI) + 2 * Math.PI) % (2 * Math.PI) - Math.PI;
    }

    function calcShadowBearing(p1, p2) {
      const dx = p2.x - p1.x;
      const dy = p1.y - p2.y;
      return normalizeAngle(Math.atan2(dx, dy));
    }

    // å½±ã‚ã‚Šæ¨å®š
    function estimateTimeFromShadow(dateStr, lat, lon, shadowAz) {
      const day   = new Date(dateStr + 'T00:00:00');
      const times = SunCalc.getTimes(day, lat, lon);
      const start = times.sunrise.getTime();
      const end   = times.sunset.getTime();
      const step  = 60 * 1000;
      let best    = { diff: Infinity, time: null, alt: null, az: null };

      for (let t = start; t <= end; t += step) {
        const pos     = SunCalc.getPosition(new Date(t), lat, lon);
        const azNorth = normalizeAngle(pos.azimuth + Math.PI);
        const diff    = Math.abs(normalizeAngle(azNorth - shadowAz));
        if (diff < best.diff) {
          best = { diff, time: new Date(t), alt: pos.altitude, az: pos.azimuth };
        }
      }
      return best;
    }

    // å½±ãªã—å¼·åˆ¶æ¨å®šï¼ˆä¿®æ­£ï¼‰
    function estimateTimeWithoutShadow(dateStr, lat, lon) {
      const day   = new Date(dateStr + 'T00:00:00');
      const times = SunCalc.getTimes(day, lat, lon);
      return times.solarNoon;
    }

    document.getElementById('imageInput').addEventListener('change', e => {
      const file   = e.target.files[0];
      const reader = new FileReader();
      img = new Image();

      reader.onload = evt => {
        img.src = evt.target.result;
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          EXIF.getData(img, function() {
            const lat     = EXIF.getTag(this, 'GPSLatitude');
            const lon     = EXIF.getTag(this, 'GPSLongitude');
            const dateRaw = EXIF.getTag(this, 'DateTimeOriginal');
            if (lat && lon) {
              document.getElementById('latitude').value  = lat;
              document.getElementById('longitude').value = lon;
            }
            if (dateRaw) {
              const d = dateRaw.replace(/^(\d{4}):(\d{2}):(\d{2}).*/, '$1-$2-$3');
              document.getElementById('dateInput').value = d;
            }
            document.getElementById('output').textContent =
              'Exifæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚å½±ã‚’ãƒãƒ¼ã‚¯ã—ã¦ãã ã•ã„ã€‚';
          });
        };
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('markShadowBtn').onclick = () => {
      shadowPoints = [];
      measuredAz   = null;
      marking      = true;
      document.getElementById('output').textContent =
        'ç”»é¢ã‚’2å›ã‚¿ãƒƒãƒ—ã—ã¦ã€Œå½±ã®å§‹ç‚¹ã€ã€Œå½±ã®çµ‚ç‚¹ã€ã‚’æŒ‡å®šã—ã¦ãã ã•ã„';
    };

    document.getElementById('resetShadowBtn').onclick = () => {
      shadowPoints = [];
      measuredAz   = null;
      marking      = false;
      if (img) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      }
      document.getElementById('output').textContent = 'å½±ãƒãƒ¼ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚';
    };

    canvas.addEventListener('pointerdown', e => {
      if (!marking) return;
      const rect = canvas.getBoundingClientRect();
      const x    = e.clientX - rect.left;
      const y    = e.clientY - rect.top;
      shadowPoints.push({ x, y });
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2*Math.PI);
      ctx.fill();

      if (shadowPoints.length === 2) {
        marking = false;
        ctx.strokeStyle = 'red';
        ctx.beginPath();
        ctx.moveTo(shadowPoints[0].x, shadowPoints[0].y);
        ctx.lineTo(shadowPoints[1].x, shadowPoints[1].y);
        ctx.stroke();
        measuredAz = calcShadowBearing(shadowPoints[0], shadowPoints[1]);
        document.getElementById('output').textContent =
          `æ¸¬å®šã•ã‚ŒãŸå½±ã®æ–¹ä½: ${(measuredAz * 180/Math.PI).toFixed(2)}Â°`;
      }
    });

    document.getElementById('estimateTimeBtn').onclick = () => {
      if (measuredAz === null) {
        return alert('ã¾ãšã€Œå½±ã‚’ãƒãƒ¼ã‚¯ã€ã§å§‹ç‚¹ãƒ»çµ‚ç‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');
      }
      const lat  = parseFloat(document.getElementById('latitude').value);
      const lon  = parseFloat(document.getElementById('longitude').value);
      const date = document.getElementById('dateInput').value;
      if (isNaN(lat) || isNaN(lon) || !date) {
        return alert('ç·¯åº¦ãƒ»çµŒåº¦ãƒ»æ’®å½±æ—¥ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
      }

      const best    = estimateTimeFromShadow(date, lat, lon, measuredAz);
      const timeStr = best.time.toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });
      const altDeg  = (best.alt * 180/Math.PI).toFixed(2);
      const azDeg   = (best.az  * 180/Math.PI).toFixed(2);

      document.getElementById('output').textContent =
        `æ¨å®šçµæœï¼š\n` +
        `æ’®å½±æ¨å®šæ™‚åˆ»: ${timeStr}\n` +
        `å¤ªé™½é«˜åº¦: ${altDeg}Â°\n` +
        `å¤ªé™½æ–¹ä½: ${azDeg}Â°\n` +
        `èª¤å·®: ${best.diff.toFixed(4)} rad`;
    };

    document.getElementById('forceEstimateBtn').onclick = () => {
      const lat  = parseFloat(document.getElementById('latitude').value);
      const lon  = parseFloat(document.getElementById('longitude').value);
      const date = document.getElementById('dateInput').value;
      if (isNaN(lat) || isNaN(lon) || !date) {
        return alert('ç·¯åº¦ãƒ»çµŒåº¦ãƒ»æ’®å½±æ—¥ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
      }
      const noon = estimateTimeWithoutShadow(date, lat, lon);
      const timeStr = noon.toLocaleTimeString('ja-JP', { hour:'2-digit', minute:'2-digit' });
      document.getElementById('output').textContent =
        `å½±ãªã—å¼·åˆ¶æ¨å®šï¼š\n` +
        `æ¨å®šæ’®å½±æ™‚åˆ»: ${timeStr}ï¼ˆå¤ªé™½å—ä¸­ï¼‰\n` +
        `â€»ç°¡æ˜“æ¨å®šã§ã™ã€‚èª¤å·®ãŒå¤§ãã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
    };
  </script>
</body>
</html>
